---
title: "Lista 1 - Técnicas de Muestreo"
author: "Boris M Fazio"
date: "2017-04-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd("C:/Users/bfazio/Desktop/analisis/tecmues")
r2 <- function(x) round(x,2)
library(data.table)
library(magrittr)
```

## Ejercicio 27

En una investigación para estudiar la relación entre la propensión al consumo de alcohol por parte de adolescentes varones y variables como el control parental, regulación emocional y madurez social, se desea tomar un MASs para sólo el distrito de San Miguel. Puesto que la propensión se medirá mediante una proporción, es de interés estimar esta proporción con un margen de error no mayor a 0.07 y un nivel de confianza del 95%. Usando en lo posible el paquete survey de R.

1. Halle el tamaño de muestra requerido para este estudio. Para esto y para crear su marco muestral puede hacer uso de la página web del Ministerio de Educación (<http://escale.minedu.gob.pe/web/inicio/padron-de-iiee>), la cual contiene información de todos los colegios del país en base al censo nacional escolar del 2016.

**Respuesta:** Usamos la fórmula de Hájek para estimar intervalos de confianza en una población finita, aplicada a una proporción:

$$\text{IC} = \left[ \bar{p} - z_{1-\alpha/2} \sqrt{\frac{\bar{p}(1-\bar{p})}{n-1} \left(1-\frac{n}{N}\right)} , \bar{p} + z_{1-\alpha/2} \sqrt{\frac{\bar{p}(1-\bar{p})}{n-1} \left(1-\frac{n}{N}\right)} \right]$$
Definiendo el error de estimación como $e = \left|p-\bar{p}\right|$, el intervalo anterior implica:

$$e = z_{1-\alpha/2} \sqrt{\frac{\bar{p}(1-\bar{p})}{n} \left( 1 - \frac{n}{N} \right)} \rightarrow n = \frac{z^2_{1-\alpha/2} \bar{p}(1-\bar{p}) N}{z^2_{1-\alpha/2} \bar{p}(1-\bar{p}) + e^2 N}$$
Dados los datos del problema: $z_{.975} = 1.96$, $e = 0.07$. Desconocemos la proporción poblacional de propensión al consumo de alcohol, así que asumimos $\bar{p} = 0.5$. Para determinar $N$ debemos examinar nuestro marco muestral, dado por la cantidad de alumnos varones cursando secundaria en IIEE del distrito de San Miguel:

```{r}
z <- 1.96; e <- 0.07; p <- 0.5

iiee <- fread("minedu.csv")[,`Alumnos (2016)`:=as.double(`Alumnos (2016)`)]
iiee[Género=="Mixto",`Alumnos (2016)`:=`Alumnos (2016)`*0.5] #Asumimos que los colegios mixtos tienen 50% de alumnos varones
N <- sum(iiee$`Alumnos (2016)`)
```

Finalmente, aplicamos la fórmula a los datos:

```{r}
n <- ceiling((z^2)*p*(1-p)*N/((z^2)*p*(1-p)+(e^2)*N)) #Redondeamos al entero superior
```
```{r, echo=FALSE}
cat(paste("n =",n))
```

2. Tome la muestra anterior y estime en base a ella el total de alumnos matriculados el 2016 en los colegios de varones de San Miguel, así como la proporción de estudiantes que pertenecen a un colegio de gestión privada. En ambos casos obtenga el error de estimación estimado de los estimadores correspondientes.

**Respuesta:**  Bajo los supuestos del ejercicio anterior, generamos una muestra de la población considerando las variables requeridas.

```{r}
iiee[,`Gestión / Dependencia`:=gsub(pattern = " - .*","",iiee$`Gestión / Dependencia`)]
poblacion <- iiee[,.(alumnos=sum(`Alumnos (2016)`)),.(Género,`Gestión / Dependencia`)]

set.seed(2017)
muestra <- poblacion[rep(1:4,times=poblacion$alumnos),1:2][sample(N, n)]

table(muestra$Género,muestra$`Gestión / Dependencia`)
```

Con las observaciones obtenidas, calculamos los estimadores puntuales y de intervalo:

```{r}
#Proporciones:
p_varon <- nrow(muestra[Género=="Varones"])/n
p_priva <- nrow(muestra[`Gestión / Dependencia`=="Privada"])/n

#ICs:
e_varon <- z*sqrt((p_varon*(1-p_varon)/(n-1))*(1-(n/N)))
e_priva <- z*sqrt((p_priva*(1-p_priva)/(n-1))*(1-(n/N)))

#Estimadores para el total poblacional en colegios de varones:
N_varon <- N*p_varon
Nivaron <- N*(p_varon - e_varon)
Nsvaron <- N*(p_varon + e_varon)
```
```{r, echo=FALSE}
cat(paste("Total de alumnos en colegios de varones:",r2(N_varon),"IC95: [",r2(Nivaron),"-",r2(Nsvaron),"]"))
cat(paste("Proporción de alumnos en colegios privados:",r2(p_priva),"IC95: [",r2(p_priva-e_priva),"-",r2(p_priva+e_priva),"]"))

```
3. ¿Cree usted que el diseño MASs empleado sea apropiado para los fines de este estudio? Indique si no fuera el caso, qué dificultades acarrea este diseño.

**Respuesta:** No. Dado que el estudio tiene como meta comparar la proporción de alumnos propensos a consumir alcohol en relación a otras características, es deseable minimizar el error de estimación para la proporción de cada subgrupo generado por los valores de las variables de interés. Ya que estos valores probablemente no tengan una distribución uniforme en la población total, es posible que un MAS dé como resultado un número de observaciones reducido para algunos subgrupos, con un error de estimación elevado como consecuencia.

---

$$\text{Cov}(\bar{X},\bar{Y}) = \left(1-\frac{n}{N}\right)\frac{\sigma_{xy}}{n}, \sigma_{xy} = \frac{1}{N-1}\sum_{i=1}^N \left( x_i - \mu_x \right) \left( y_i - \mu_y \right)$$

$$\text{Cov}(\bar{X},\bar{Y}) = \mathrm{E}\left[\left(\bar{X}-\mathrm{E}\bar{X}\right)\left(\bar{Y}-\mathrm{E}\bar{Y}\right)\right]= \mathrm{E}\left[\bar{X}\bar{Y}\right] - \mu_x\mu_y$$

$$\mathrm{E}\left[\bar{X}\bar{Y}\right] = \mathrm{E}\left[\frac{1}{n}\sum_{i=1}^N x_i\delta_i\frac{1}{n}\sum_{i=1}^N y_i\delta_i\right] = \frac{1}{n^2}\mathrm{E}\left[\left(x_1\delta_1 + x_2\delta_2 + ... + x_N\delta_N\right)\left(y_1\delta_1 + y_2\delta_2 + ... + y_N\delta_N\right)\right]$$

$$\left(x_1\delta_1 + x_2\delta_2 + ... + x_N\delta_N\right)\left(y_1\delta_1 + y_2\delta_2 + ... + y_N\delta_N\right) = \sum_{i=1}^N x_iy_i\delta_i^2 + \sum_{j\neq 1}^N x_1\delta_1y_j\delta_j + \sum_{j\neq 2}^N x_2\delta_2y_j\delta_j + ...+ \sum_{j\neq N}^N x_N\delta_Ny_j\delta_j$$

$$\mathrm{E}\left[\sum_{i=1}^N x_iy_i\delta_i^2\right] = \sum_{i=1}^N x_iy_i\mathrm{E}\left[\delta_i^2\right] = \frac{n}{N} \sum_{i=1}^N x_iy_i$$
Posible paso dudoso (verificar Edidj):

$$\mathrm{E}\left[\sum_{j\neq i}^N x_iy_j\delta_i\delta_j\right] = \sum_{j\neq i}^N x_iy_j\mathrm{E}\left[\delta_i\delta_j\right] = \frac{n}{N}\left(\frac{n-1}{N-1}\right)x_i\sum_{j\neq i}^Ny_j = \frac{n}{N}\left(\frac{n-1}{N-1}\right)x_i\left(N\mu_y - y_i\right)$$

$$\mathrm{E}\left[\bar{X}\bar{Y}\right] = \frac{1}{n^2}\left(\frac{n}{N} \sum_{i=1}^N x_iy_i + \frac{n}{N}\left(\frac{n-1}{N-1}\right)\sum_{i=1}^N x_i\left(N\mu_y - y_i\right)\right)$$

$$\sum_{i=1}^N x_i\left(N\mu_y - y_i\right) = \sum_{i=1}^N x_iN\mu_y - \sum_{i=1}^N x_iy_i = N^2 \mu_x \mu_y- \sum_{i=1}^N x_iy_i$$

$$\mathrm{E}\left[\bar{X}\bar{Y}\right] = \frac{1}{nN}\left(\sum_{i=1}^N x_iy_i + \left(\frac{n-1}{N-1}\right)\left(N^2 \mu_x \mu_y- \sum_{i=1}^N x_iy_i\right)\right)$$

$$\text{Cov}(\bar{X},\bar{Y}) = \frac{1}{nN}S - \frac{n-1}{nN(N-1)}S+\frac{N(n-1)}{n(N-1)}\mu_x\mu_y - \mu_x\mu_y=S \frac{N-n}{nN(N-1)} - \mu_x\mu_y\frac{N-n}{n(N-1)} = \frac{N-n}{n(N-1)}\left(\frac{S}{N}-\mu_x\mu_y\right) = \frac{N-n}{nN}\sigma_{xy} = \left(1-\frac{n}{N}\right)\frac{\sigma_{xy}}{n}$$
